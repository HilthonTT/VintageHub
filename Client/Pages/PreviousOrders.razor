@page "/Order/Previous"
@inject IUserEndpoint UserEndpoint
@inject IOrderEndpoint OrderEndpoint
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>My Previous Orders</PageTitle>

@if (isLoading is false)
{
    <MudGrid Class="mt-3 mb-5">
        <MudItem xs="12">
            <div class="d-flex justify-content-between">
                <MudText Typo="Typo.h6" Class="fw-bold text-uppercase">
                    My Previous Orders
                </MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="ClosePage" />
            </div>
        </MudItem>
        <MudDivider Class="mb-3" />
        <MudItem xs="12">
            @if (orders is not null)
            {
                <MudDataGrid T="OrderDisplayModel" Items="orders" Filterable="true" SortMode="SortMode.Multiple" ReadOnly="false"
                             Hideable="true" Bordered="true" Hover="true" Striped="true" QuickFilter="quickFilter"
                             EditTrigger="DataGridEditTrigger.Manual" CommittedItemChanges="UpdateOrderAsync">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Orders</MudText>
                        <MudSpacer />
                        <MudTextField @bind-Value="searchText" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
                                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" />
                    </ToolBarContent>
                    <Columns>
                        <SelectColumn T="OrderDisplayModel" />
                        <PropertyColumn Property="x => x.Id" Title="Id" Sortable="false" Filterable="false" IsEditable="false" />
                        <PropertyColumn Property="x => x.FullName" Title="Buyer" IsEditable="false" />
                        <PropertyColumn Property="x => x.TotalPrice" Title="Total Price &euro;" IsEditable="false" />
                        <PropertyColumn Property="x => x.DateOrdered" Title="Date Ordered" IsEditable="false" />
                        <PropertyColumn Property="x => x.IsComplete" Title="Completed" IsEditable="true">
                            <EditTemplate>
                                <MudCheckBox @bind-Checked="@context.Item.IsComplete" Color="Color.Primary" Label="Completed" />
                            </EditTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x => x.IsCanceled" Title="Canceled" IsEditable="true">
                            <EditTemplate>
                                <MudCheckBox @bind-Checked="@context.Item.IsCanceled" Color="Color.Primary" Label="Canceled" />
                            </EditTemplate>
                        </PropertyColumn>
                        <TemplateColumn>
                            <CellTemplate>
                                <MudStack Row="true">
                                    <MudButton OnClick="() => LoadOrderDetailsPage(context.Item)" Size="Size.Small"
                                               Variant="Variant.Filled" Color="Color.Primary">
                                        Open Order
                                    </MudButton>
                                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit"
                                                   OnClick="@context.Actions.StartEditingItemAsync" />
                                </MudStack>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                    <PagerContent>
                        <MudDataGridPager T="OrderDataModel" />
                    </PagerContent>
                </MudDataGrid>
            }
        </MudItem>
    </MudGrid>
}
else
{
    <LoadingTemplate />
}

@code {
    private UserModel loggedInUser;
    private ObservableCollection<OrderDisplayModel> orders;

    private string searchText = "";
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        loggedInUser = await AuthProvider.GetUserFromAuth(UserEndpoint);
        await LoadOrdersAsync();

        isLoading = false;
    }

    private void ClosePage()
    {
        Navigation.NavigateTo("/");
    }

    private void LoadOrderDetailsPage(OrderDisplayModel order)
    {
        Navigation.NavigateTo($"/Order/Details/{order.Id}");
    }

    private async Task LoadOrdersAsync()
    {
        if (loggedInUser is null)
        {
            return;
        }

        var orderList = await OrderEndpoint.GetOrdersByUserIdAsync(loggedInUser.Id);
        orders = new(orderList);
    }

    private async Task UpdateOrderAsync(OrderDisplayModel order)
    {
        orders.Remove(order);

        var updatedOrder = new OrderModel
            {
                Id = order.Id,
                UserId = order.User.Id,
                TotalPrice = order.TotalPrice,
                IsCanceled = order.IsCanceled,
                IsComplete = order.IsComplete,
                DateOrdered = order.DateOrdered,
            };

        var orderDetails = await OrderEndpoint.GetOrderDetailsByOrderIdAsync(updatedOrder.Id);

        var ordersList = new List<OrderDetailsModel>();
        foreach (var o in orderDetails)
        {
            var newOrder = new OrderDetailsModel(o);
            ordersList.Add(newOrder);
        }

        var request = new OrderRequestModel(updatedOrder, ordersList);

        await OrderEndpoint.UpdateOrderAsync(request);
    }

    private Func<OrderDisplayModel, bool> quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            return true;
        }

        if (x.FullName.Contains(searchText, StringComparison.InvariantCultureIgnoreCase))
        {
            return true;
        }

        return false;
    };
}
